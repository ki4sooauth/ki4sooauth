<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.gooagoo.dao.business.bill.transaction.OrderInfoBusinessMapper" >
  <resultMap id="OrderInfoBusinessResultMap" type="com.gooagoo.entity.business.transaction.OrderInfoBusiness" >
    <id column="order_id" property="orderId" jdbcType="CHAR" />
    <result column="shop_id" property="shopId" jdbcType="CHAR" />
    <result column="pay_price" property="payPrice" jdbcType="CHAR" />
    <result column="pic_url" property="picUrl" jdbcType="CHAR" />
    <result column="request_time" property="requestTime" jdbcType="CHAR" />
  </resultMap>
  
  <resultMap id="PurchasedGoodsBusinessResultMap" type="com.gooagoo.entity.business.transaction.PurchasedGoodsBusiness" >
    <result column="goods_id" property="goodsId" jdbcType="CHAR" />
    <result column="goods_name" property="goodsName" jdbcType="CHAR" />
    <result column="goods_img" property="goodsImg" jdbcType="CHAR" />
    <result column="shop_id" property="shopId" jdbcType="CHAR" />
    <result column="shop_entity_id" property="shopEntityId" jdbcType="CHAR" />
    <result column="shop_name" property="shopName" jdbcType="CHAR" />
    <result column="goods_num" property="goodsNum" jdbcType="CHAR" />
    <result column="pay_price" property="payPrice" jdbcType="CHAR" />
    <result column="request_time" property="requestTime" jdbcType="CHAR" />
  </resultMap>
  
  <select id="countOrderInfoList" resultType="java.lang.Integer">
	SELECT count(*) FROM (SELECT bill.* FROM
		gooagoo_bill.order_info bill,
		gooagoo_bill.order_detail_info detail
	WHERE
	detail.order_id = bill.order_id
	AND bill.is_del = 'N'
	AND	bill.user_id = #{userId}
	AND bill.bill_type = '3' <!-- 账单 -->
	<if test="shopId!=null">
	AND bill.shop_id = #{shopId}
	</if>
	<if test="begin!=null">
	AND bill.request_time > #{begin}
	</if>
    <if test="end!=null">
    AND bill.request_time &lt; #{end}
    </if>
    <if test="goodsName!=null">
    AND detail.goods_name LIKE CONCAT('%',#{goodsName},'%')
    </if>
    GROUP BY bill.order_id) t
  </select>
  
  <select id="findOrderInfoList" resultMap="OrderInfoBusinessResultMap">
	SELECT
		bill.order_id,
		bill.shop_id,
		bill.request_time,
		bill.pay_price,
		(
			SELECT
				pic_url
			FROM
				gooagoo_bill.order_pic pic
			WHERE
				pic.order_id = bill.order_id
		) AS pic_url
	FROM
		gooagoo_bill.order_info bill,
		gooagoo_bill.order_detail_info detail
	WHERE
	detail.order_id = bill.order_id
	AND bill.is_del = 'N'
	AND	bill.user_id = #{userId}
	AND bill.bill_type = '3' <!-- 账单 -->
	<if test="shopId!=null">
	AND bill.shop_id = #{shopId}
	</if>
	<if test="begin!=null">
	AND bill.request_time > #{begin}
	</if>
    <if test="end!=null">
    AND bill.request_time &lt; #{end}
    </if>
    <if test="goodsName!=null">
    AND detail.goods_name LIKE CONCAT('%',#{goodsName},'%')
    </if>
	GROUP BY bill.order_id
	<if test="orderBy!=null">
	ORDER BY ${orderBy}
	</if>
	<if test="pageSize!=null">
	LIMIT 
	   <if test="pageIndex!=null">
	   		${pageIndex},
	   </if>
	      ${pageSize}  
	</if>
  </select>
  <select id="findBoughtGoodsList" resultMap="PurchasedGoodsBusinessResultMap">
	SELECT
		detail.goods_id,
		detail.goods_name,
		market.goods_img,
		detail.shop_id,
		detail.shop_entity_id,
		shop.shop_name,
		detail.goods_num,
		detail.pay_price,
		bill.request_time
	FROM
		gooagoo_bill.order_info bill,
		gooagoo_bill.order_detail_info detail,
		gooagoo_shop.shop_info shop,
		gooagoo_goods.goods_marketing_info market
	WHERE
		bill.order_id = detail.order_id
	AND detail.shop_id = shop.shop_id
	AND detail.goods_id = market.goods_id
	AND	bill.bill_type = '3'
	AND bill.is_del = 'N'
	<if test="userId!=null">
		AND bill.user_id = #{userId}
	</if>
	<if test="shopId!=null">
		AND bill.shop_id = #{shopId}
	</if>
	<if test="shopEntityId!=null">
		AND bill.shop_entity_id = #{shopEntityId}
	</if>
	<if test= "shopIdList != null">
        AND bill.shop_id IN 
        	<foreach collection="shopIdList" item="item" open="("  close=")" separator=",">
           		#{item}
            </foreach>
   	</if>
   	<if test= "begin != null">
        AND bill.request_time >= #{begin}
   	</if>
	<if test= "end != null">
        AND bill.request_time &lt;= #{end}
   	</if>
	<if test= "goodsName != null">
        AND detail.goods_name LIKE CONCAT('%',#{goodsName},'%')
   	</if>
	GROUP BY detail.goods_id
	ORDER BY bill.request_time DESC
	<if test="pageSize!=null">
	LIMIT 
	   <if test="pageIndex!=null">
	   		${pageIndex},
	   </if>
	      ${pageSize}  
	</if>
  </select>
  
  </mapper>